{"version":3,"sources":["../src/components/DataGrid/useDataGrid.ts"],"sourcesContent":["import * as React from 'react';\nimport { useArrowNavigationGroup, useFocusFinders } from '@fluentui/react-tabster';\nimport type { DataGridProps, DataGridState } from './DataGrid.types';\nimport { useTable_unstable } from '../Table/useTable';\nimport { useEventCallback, useMergedRefs } from '@fluentui/react-utilities';\nimport { End, Home } from '@fluentui/keyboard-keys';\nimport {\n  useTableFeatures,\n  useTableSort,\n  useTableSelection,\n  useTableColumnSizing_unstable,\n  useTableCompositeNavigation,\n} from '../../hooks';\nimport { CELL_WIDTH } from '../TableSelectionCell';\n\n/**\n * Create the state required to render DataGrid.\n *\n * The returned state can be modified with hooks such as useDataGridStyles_unstable,\n * before being passed to renderDataGrid_unstable.\n *\n * @param props - props from this instance of DataGrid\n * @param ref - reference to root HTMLElement of DataGrid\n */\nexport const useDataGrid_unstable = (props: DataGridProps, ref: React.Ref<HTMLElement>): DataGridState => {\n  const {\n    items,\n    columns,\n    focusMode = 'cell',\n    selectionMode,\n    onSortChange,\n    onSelectionChange,\n    defaultSortState,\n    sortState,\n    selectedItems,\n    defaultSelectedItems,\n    subtleSelection = false,\n    selectionAppearance = 'brand',\n    getRowId,\n    resizableColumns,\n    columnSizingOptions,\n    onColumnResize,\n    containerWidthOffset,\n    resizableColumnsOptions = {},\n  } = props;\n\n  const widthOffset = containerWidthOffset ?? (selectionMode ? -CELL_WIDTH : 0);\n\n  const gridTabsterAttribute = useArrowNavigationGroup({\n    axis: 'grid',\n  });\n\n  const {\n    onTableKeyDown: onCompositeKeyDown,\n    tableTabsterAttribute: compositeTabsterAttribute,\n    tableRowTabsterAttribute: compositeRowTabsterAttribute,\n  } = useTableCompositeNavigation();\n\n  const tableState = useTableFeatures({ items, columns, getRowId }, [\n    useTableSort({\n      defaultSortState,\n      sortState,\n      onSortChange,\n    }),\n    useTableSelection({\n      defaultSelectedItems,\n      selectedItems,\n      onSelectionChange,\n      selectionMode: selectionMode ?? 'multiselect',\n    }),\n    useTableColumnSizing_unstable({\n      onColumnResize,\n      columnSizingOptions,\n      // The selection cell is not part of the columns, therefore its width needs to be subtracted\n      // from the container to make sure the columns don't overflow the table.\n      containerWidthOffset: widthOffset,\n      // Disables automatic resizing of columns when the container overflows.\n      // This allows the sum of the columns to be larger than the container.\n      autoFitColumns: resizableColumnsOptions.autoFitColumns ?? true,\n    }),\n  ]);\n\n  const innerRef = React.useRef<HTMLDivElement>(null);\n  const { findFirstFocusable, findLastFocusable } = useFocusFinders();\n  const onKeyDown = useEventCallback((e: React.KeyboardEvent<HTMLTableElement>) => {\n    props.onKeyDown?.(e);\n    focusMode === 'composite' && onCompositeKeyDown(e);\n\n    // handle ctrl+home and ctrl+end\n    if (!innerRef.current || !e.ctrlKey || e.defaultPrevented) {\n      return;\n    }\n\n    if (e.key === Home) {\n      const firstRow = innerRef.current.querySelector('[role=\"row\"]') as HTMLElement | null;\n      if (firstRow) {\n        findFirstFocusable(firstRow)?.focus();\n      }\n    }\n\n    if (e.key === End) {\n      const rows = innerRef.current.querySelectorAll('[role=\"row\"]');\n      if (rows.length) {\n        const lastRow = rows.item(rows.length - 1);\n        findLastFocusable(lastRow as HTMLElement)?.focus();\n      }\n    }\n  });\n\n  const baseTableState = useTable_unstable(\n    {\n      role: 'grid',\n      as: 'div',\n      noNativeElements: true,\n      ...(focusMode === 'cell' && gridTabsterAttribute),\n      ...(focusMode === 'composite' && compositeTabsterAttribute),\n      ...props,\n      onKeyDown,\n      ...(resizableColumns ? tableState.columnSizing_unstable.getTableProps(props) : {}),\n    },\n    useMergedRefs(ref, tableState.tableRef, innerRef),\n  );\n\n  return {\n    ...baseTableState,\n    focusMode,\n    tableState,\n    selectableRows: !!selectionMode,\n    subtleSelection,\n    selectionAppearance,\n    resizableColumns,\n    compositeRowTabsterAttribute,\n  };\n};\n"],"names":["useDataGrid_unstable","props","ref","items","columns","focusMode","selectionMode","onSortChange","onSelectionChange","defaultSortState","sortState","selectedItems","defaultSelectedItems","subtleSelection","selectionAppearance","getRowId","resizableColumns","columnSizingOptions","onColumnResize","containerWidthOffset","resizableColumnsOptions","widthOffset","CELL_WIDTH","gridTabsterAttribute","useArrowNavigationGroup","axis","onTableKeyDown","onCompositeKeyDown","tableTabsterAttribute","compositeTabsterAttribute","tableRowTabsterAttribute","compositeRowTabsterAttribute","useTableCompositeNavigation","tableState","useTableFeatures","useTableSort","useTableSelection","useTableColumnSizing_unstable","autoFitColumns","innerRef","React","useRef","findFirstFocusable","findLastFocusable","useFocusFinders","onKeyDown","useEventCallback","e","current","ctrlKey","defaultPrevented","key","Home","firstRow","querySelector","focus","End","rows","querySelectorAll","length","lastRow","item","baseTableState","useTable_unstable","role","as","noNativeElements","columnSizing_unstable","getTableProps","useMergedRefs","tableRef","selectableRows"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}